# CVE-2020-19704

<font size=3>

1. [Contents](#Contents)
    - [Exploit Directory](#exploit-directory)
    - [VulnerableFramework Directory](#vulnerableframework-directory)
2. [The CVE](#the-cve)
    - [Details](#details)
    - [Root Cause of the Vulnerability](#root-cause-of-the-vulnerability)
    - [Potential Attack Scenario](#potential-attack-scenario)
3. [The Vulnerable Framework](#the-vulnerable-framework)
    - [Description](#description)
    - [Build Instructions](#build-instructions)
    - [Deployment Instructions](#deployment-instructions)
    - [Static Analysis Results](#static-analysis-results)
        - [Spotbugs](#spotbugs)
        - [SonarQube](#sonarqube)
        - [Vulnerability Analysis](#vulnerability-analysis)
        - [Security Hotspots Analysis](#security-hotspots-analysis)
    - [CVE Vulnerabilities](#cve-vulnerabilities)
4. [Exploitation of the Vulnerability](#exploitation-of-the-vulnerability)
    - [Running the Framework](#running-the-framework)
    - [Running the Exploit](#running-the-exploit)
    - [Analysis of the Exploitation Outcome](#analysis-of-the-exploitation-outcome)
5. [Possible Security Patch](#possible-security-patch)

</font>


## **Contents**
### **Exploit Directory**
This directory contains a single **python script** named **exploit.py** that will be used to trigger a specific vulnerability found in the application. Furthermore it is also present a **README.md** file that shows how to execute the python script.


### **VulnerableFramework Directory**
**VulnerableFramework** directory contains two different subdirectories:

- **Docker**: contains a collection of scripts and configuration files that will be used to properly run the vulnerable framework in a dockerized enviroment.


- **spring-boot-admin**: contains the **spring-boot-admin** projects sources from which the framework can be built.

Additional information about the **Docker** directory contents as well as information on how to deploy the framework, can be obtained by reading the **README.md** file in this same folder.


## **The CVE**
### **Details**
In this section a detailed description of CVE-2021-42392 will be provided, the following is a first description provided by the NIST:

> A stored cross-site scripting (XSS) vulnerability via ResourceController.java in spring-boot-admin as of 20190710 allows attackers to execute arbitrary web scripts or HTML.

This CVE refers to an open source project called [Spring-Boot-Admin](https://github.com/sail-y/spring-boot-admin) that contains a **Stored XSS** vulnerability that was flagged in a Github [issue](https://github.com/sail-y/spring-boot-admin/issues/7) by a project contributor.


### **Root Cause of the Vulnerability**
The root cause of the vulnerability is that when a **PUT** request is sent to the **/resource** endpoint, the body doesn't get sanitized and some of the input directly provided by the user, gets inserted in the DOM of the webpage causing a code injection.

In the following screenshot it is possible to notice how the **resource** received in the body is simply passed to the **ResourceService** which in turn will map it to a **Resource** model object.

![Vulnerable Code](./images/spa_vulnerable_code.png)

### **Potential Attack Scenario**
As a potential attack scenario we could think about the situation in which a **Spring Boot** application is using this framework for **resources and roles management**.

In order for the attack to be feasible there is only one requirement: the attacker must be authenticated to the backend management system and able send **PUT** requests to the **/resource** endpoint.




## **The Vulnerable Framework**
### **Description**
The vulnerable framework I've identified is the same one for which [CVE-2020-19704](https://nvd.nist.gov/vuln/detail/CVE-2020-19704) was issued and it is called [Spring-Boot-Admin](https://github.com/sail-y/spring-boot-admin): an open source **Background Management System** used for handling **user-roles** and **application resources**.

</br>

After having deployed the framework, the following login page can be retrieved at the URL **http://localhost:10000/web/views/login/login.html**.

</br>

**Login Page**

![Login Page](./images/spa_sign_in.png)

</br>

By using as username "**admin**" and as password "**111111**", you will be redirected to the homepage shown here below:


![Homepage](./images/spa_homepage.png)

</br></br>

To access the resources menu just **expand the only option** inside the **left sidebar** and then **click the first option** that appears, as shown in the picture.

![Navbar](./images/spa_menu.png)


</br></br>

The page shown here below is the one from which an admin can customize the active resources of a Spring Boot application; in section [Exploitation of the Vulnerability](#exploitation-of-the-vulnerability) we will resume from this page in order to exploit the **stored XSS vulnerability**

![Resources menu](./images/spa_resources_menu.png)



### **Build Instructions**
The project can be built from scratch by following these steps:

1. Open with **IntelliJ** the project **spring-boot-admin** located in **VulnerableFramework** folder (In IntelliJ: File > Open).

2. Go to **File > Project Structure**, Project tab and make sure that the **JDK version is 1.8**. To build the project **I've used JDK 1.8** with **Language Level 8 - Lambdas, type annotations etc**.

</br>

![Project Structure](./images/spa_project_struct.png)


</br></br>

3. Go to **File > Settings**, expand **Build, Execution, Deployment** tab on the left, expand **Build Tools** tab and select **Maven**; make sure you are using Maven **version 3** (I've used **Maven 3.8.1** to build the project).

</br>

![Maven](./images/spa_maven.png)

</br></br>

4. Synchronize Maven dependencies by expanding the Maven tab on the right and clicking the **Reload All Maven Projects** arrows and execute the **package** task.

</br>

![Maven Sidebar](./images/spa_maven_sidebar.png)

</br></br>

**ATTENTION!** </br>
This project in order to be compiled and packaged in a **.jar** file, **requires a MySQL DBMS** instance running. </br>
If it is wanted to manually build this project, it will be necessary to execute a MySQL DBMS (for example with **Docker**) and to properly change the connection settings that can be found in the configuration file **/src/main/resources/application-dev.yml**.

The settings that may need to be updated are the following ones:

- **url** field: 
~~~ 
jdbc:mysql://localhost:3306/dmc?useUnicode=true&characterEncoding=utf8&autoReconnect=true&rewriteBatchedStatements=TRUE&useSSL=false 
~~~

where instead of **localhost:3306** you may want to insert another address (not needed if using a local docker container).

</br>

- username field: **user** 
- password field: **password**

</br>

In **Docker** directory I've provided both a way to launch the entire infrastructure all at once via **Docker Compose** (withouth the need of building anything), but also a way to only launch a MySQL container that can be used in the building phase; further details will be provided in the next [section](#deployment-instructions) and in the **README.md** file inside **Docker** folder. 



### **Deployment Instructions**
This framework is composed by two different components:

1. The **application** itself that can be built following the procedure described in the previous [section](#build-instructions).

2. A **MySQL DBMS** that must be running while using the framework as all information are stored in a specific Database named **dmc**

</br>

In the **Docker** directory many configuration files can be found, here I'm going to present an overview of them:

1. **Docker Files**
    - **App_Dockerfile**: copies the sources of **spring-boot-admin** project inside a container that will build those by using **Maven** and generate a **.jar** file that will be executed upon container launch.

    - **MySQL_Dockerfile**: Sets up a MySQL DBMS and executes a **.sql** script (provided by the framework developers in **spring-boot-admin/dmc/dmc.sql**) that is in charge of creating and populating the tables needed by the framework.

    The images built using these two configuration files will automatically be pulled from **Docker Hub** when using **Docker Compose**.

2. **Docker Compose Files**
    - **docker-compose-build-app.yml**: This **Docker Compose** file will launch a MySQL **db** service and will **build the Docker Image** of the application, starting from the **App_Dockerfile** configuration file.

        </br>

        The only reason why I've used this file is because I couldn't build the **App_Dockerfile** by itself as the framework requires also the MySQL DBMS running; to overcome this problem I've built the image while having the DBMS running so that I could also tag and push the same image on **Docker Hub**.

    </br>

    - **docker-compose.yml**: This last **Docker Compose** file is the only one that is needed in order to deploy the whole infrastructure; it launches a **db** service (MySQL DBMS) and an **app** service, retrieving the images respectively from [this](https://hub.docker.com/repository/docker/runcor3/spring-boot-admin-mysql/general) and [this](https://hub.docker.com/repository/docker/runcor3/spring-boot-admin-app/general) **Docker Hub repositories**.

    </br>

3. **Bash Deployment Scripts**
    - **build_and_deploy.sh**
    - **deploy_infrastructure.sh**




### **Static Analysis Results**
#### **Spotbugs**
#### **SonarQube**
#### **Vulnerability Analysis**
#### **Security Hotspots Analysis**
### **CVE Vulnerabilities**

## **Exploitation of the Vulnerability**
### **Running the Framework**
### **Running the Exploit**
### **Analysis of the Exploitation Outcome**


## **Possible Security Patch**