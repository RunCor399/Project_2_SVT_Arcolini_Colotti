package it.polito.svt.vulnapp.controller;

import it.polito.svt.vulnapp.model.Movie;
import it.polito.svt.vulnapp.service.MovieService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.servlet.ModelAndView;

import java.util.*;

@RestController
public class MovieController {

    @Autowired
    private MovieService movieService;

    @GetMapping("/movies")
    public ModelAndView getMovies() {

        /* retrieving movies from H2 database */
        List<Movie> result = movieService.getAllMovieList();

        ModelAndView mv = new ModelAndView("moviesList");
        mv.addObject("movies", result);
        return mv;
    }

    @GetMapping("/new-movie")
    public ModelAndView getNewMovieForm() {
        ModelAndView mv = new ModelAndView("movieForm");
        return mv;
    }

    @PostMapping("/save")
    public Map<String, Object> addMovie(@RequestBody Movie movie) {

        /* CVE-2022-28588: saving the movie without proper input sanitization */
        boolean success = movieService.save(movie);

        Map<String, Object> resultMap = new HashMap<>();
        resultMap.put("success", success);
        return resultMap;
    }
}
