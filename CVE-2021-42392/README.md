# CVE-2021-42392

## Content of the directory
### **VulnerableApplication Directory**
This directory contains two subdirectories:
- **src**: contains the source code of the project
- **Docker**: contains a series of scripts and configuration files that will be used to properly run the vulnerable application inside a docker container.

Additional instructions on how to run the application in a containerized enviroment will be provided in the **README** that can be found inside the **Docker** folder.

### **AttackEnviroment Directory**
This folder contains a JAR file and a python script that will be used to exploit the VulnerableApplication. Detailed instructions on how to run the attack will be provided both in the [Running the Exploit](#running-the-exploit) section and in the **README** file inside this folder.


## The CVE
### Details
In this section a detailed description of CVE-2021-42392 will be provided, the following is a first description provided by the NIST:

> The org.h2.util.JdbcUtils.getConnection method of the H2 database takes as parameters the class name of the driver and URL of the database. An attacker may pass a JNDI driver name and a URL leading to a LDAP or RMI servers, causing remote code execution. This can be exploited through various attack vectors, most notably through the H2 Console which leads to unauthenticated remote code execution.

The CVE refers to an H2 Database vulnerability that allows an attacker to obtain **Unauthenticated Remote Code Execution** by exploiting the **Java Naming and Directory Interface**; the latter can be described as a Java API for directory services that allows Java clients to obtain data and objects by their name from a Server (i.e. LDAP, RMI).

H2 Database on the other hand is a lightweight in-memory RDBMS written in Java. This makes it a popular data storage solution for various projects from web platforms like Spring Boot to IoT platforms.

This H2 Database issue has the same root cause as **Log4Shell** vulnerability in Apache Log4j (JNDI Remote Class Loading), however it shouldn't be as widespread as Log4Shell due to the following factors:

1. Unlike Log4Shell, this vulnerability typically affects the server that initially processed a malicious request sent by an attacker; this leads to a quick discovery of the vulnerable servers in an enterprise enviroment.

2. H2 Database Console by default usually listens only to localhost connections, though this setting can be easily changed allowing the console to listen for remote connections; As a matter of facts some third-party tools (i.e. JHipster) use H2 Database with H2 Console enabled and reachable from the Internet by default, thus making it suitable to this specific attack.

3. Many vendors may be using H2 Database withouth having enabled H2 Console. Although there are other attack vectors to exploit, these usually are context-dependant and less likely to be exposed to remote attackers.

### Root Cause of the Vulnerability
The root cause of this vulnerability is that H2 Database framework passes unfiltered attacker-controlled URLs to the javax.naming.Context.lookup function, which leads to Java code injection.

In the following picture it is shown a piece of the **getConnection(String driver, String url, Properties prop)** function, within **org.h2.utils.JdbcUtils**; it is trivial to check that when the driver passed as argument of the *getConnection* function is assignable to the *javax.naming.Context* class, the lookup method will be invoked on a potentially malicious URL provided by the user.

![Vulnerable Code](./images/vulnerable_code.png)

### Potential Attack Scenario
Here a possible attack scenario that could easily impact a Spring Boot application using H2 Database is presented; the requirements for the attack to be feasible are the following ones:

1. The vulnerable application runs a version of H2 Database lower or equal than 2.0.204

2. H2 Console is enabled and is exposed to the Internet

If this conditions subsist, it will be possible for an attacker to provide a specifically crafted link that forces the H2 console to download a malicious Java Class from a remote server controlled by the threat actor.
This malicious Java Class will be then automatically executed giving to the attacker the capability of executing remote commands on the server.


Here it is shown the attack flow as described by the researchers that discovered the vulnerability at [JFrog](https://jfrog.com/blog/the-jndi-strikes-back-unauthenticated-rce-in-h2-database-console/)

![Attack Flow](./images/attack_flow.avif)




## The Vulnerable Project
### Description
### Build Instructions
### Static Analysis Results
### Weaknesses

## Exploitation of the Vulnerability
### Running the Application
### Running the Exploit

## Possible Security Patch

